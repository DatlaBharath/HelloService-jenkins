{"pipeline":{"name":"build","identifier":"build","projectIdentifier":"default_project","orgIdentifier":"default","tags":{},"stages":[{"stage":{"name":"Build and Deploy","identifier":"Build_And_Deploy","type":"Custom","spec":{"execution":{"steps":[{"step":{"name":"Checkout Code","identifier":"Checkout_Code","type":"ShellScript","spec":{"shell":"Bash","source":{"type":"Inline","spec":{"script":"echo \"Cloning repo...\"\nrm -rf helloservice-jenkins\ngit clone https://github.com/DatlaBharath/helloservice-jenkins.git\ncd helloservice-jenkins\npwd\nls\n"}},"executionTarget":{},"environmentVariables":[],"outputVariables":[]},"timeout":"10m"}},{"step":{"name":"Build Project","identifier":"Build_Project","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"source":{"type":"Inline","spec":{"script":"cd helloservice-jenkins\nmvn clean install -DskipTests\n"}}}}},{"step":{"name":"Build Docker Image","identifier":"Build_Image","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"source":{"type":"Inline","spec":{"script":"cd helloservice-jenkins\ndocker build -t sakthisiddu1/helloservice-jenkins:<+pipeline.sequenceId> .\n"}}}}},{"step":{"name":"Push Docker Image","identifier":"Push_Image","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"environmentVariables":[{"name":"DOCKERHUB_USERNAME","type":"String","value":"<+secrets.getValue(\"dockerhub-username\")>"},{"name":"DOCKERHUB_PASSWORD","type":"String","value":"<+secrets.getValue(\"dockerhub-password\")>"}],"source":{"type":"Inline","spec":{"script":"cd helloservice-jenkins\necho \"$DOCKERHUB_USERNAME\"\necho \"$DOCKERHUB_PASSWORD\"\necho \"$DOCKERHUB_PASSWORD\" | docker login -u \"$DOCKERHUB_USERNAME\" --password-stdin\ndocker push $DOCKERHUB_USERNAME/helloservice-jenkins:<+pipeline.sequenceId>\n"}}}}},{"step":{"name":"Deploy to Kubernetes via SSH","identifier":"Deploy_K8s","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"source":{"type":"Inline","spec":{"script":"echo \"Creating deployment.yaml and service.yaml...\"\n\ncat <<EOF > deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: helloservice-jenkins-deployment\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: helloservice-jenkins\n  template:\n    metadata:\n      labels:\n        app: helloservice-jenkins\n    spec:\n      containers:\n      - name: helloservice-jenkins\n        image: sakthisiddu1/helloservice-jenkins:<+pipeline.sequenceId>\n        ports:\n        - containerPort: 5000\nEOF\n\ncat <<EOF > service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: helloservice-jenkins-service\nspec:\n  type: NodePort\n  selector:\n    app: helloservice-jenkins\n  ports:\n    - port: 5000\n      targetPort: 5000\n      nodePort: 30007\nEOF\n\necho \"Deploying to Kubernetes via SSH...\"\n\nssh -o StrictHostKeyChecking=no -i /home/harness/.ssh/test.pem ubuntu@65.2.137.51 \"kubectl apply -f -\" < deployment.yaml\nssh -o StrictHostKeyChecking=no -i /home/harness/.ssh/test.pem ubuntu@65.2.137.51 \"kubectl apply -f -\" < service.yaml\n\nrm -rf helloservice-jenkins\n"}}}}}]}}}}]}}